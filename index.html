<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CoinMarketCap Admin Panel</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script>
        // Load environment variables securely
        window.ENV = {};
        fetch('/api/config')
            .then(response => response.json())
            .then(config => {
                window.ENV = config;
                console.log('✅ Environment variables loaded securely');
            })
            .catch(error => {
                console.log('⚠️ Using fallback configuration');
            });
    </script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0B1426;
            min-height: 100vh;
            color: #ffffff;
            margin: 0;
            padding: 0;
            overflow-x: hidden;
        }

        .admin-container {
            display: flex;
            min-height: 100vh;
            position: relative;
        }

        /* Mobile Menu Toggle */
        .mobile-menu-toggle {
            display: none;
            position: fixed;
            top: 1rem;
            left: 1rem;
            z-index: 1001;
            background: #2D3748;
            color: #ffffff;
            border: none;
            padding: 12px;
            border-radius: 8px;
            font-size: 18px;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        /* Sidebar */
        .sidebar {
            width: 280px;
            background: #1A202C;
            border-right: 1px solid #2D3748;
            padding: 2rem 0;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            z-index: 1000;
            transition: transform 0.3s ease;
        }

        .logo {
            text-align: center;
            margin-bottom: 2rem;
            padding: 0 1.5rem;
        }

        .logo h1 {
            color: #3182CE;
            font-size: 1.5rem;
            font-weight: 700;
        }

        .logo p {
            color: #A0AEC0;
            font-size: 0.875rem;
            margin-top: 0.25rem;
        }

        .nav-menu {
            list-style: none;
            padding: 0 1rem;
        }

        .nav-item {
            margin-bottom: 0.5rem;
        }

        .nav-link {
            display: flex;
            align-items: center;
            padding: 1rem 1.5rem;
            color: #A0AEC0;
            text-decoration: none;
            border-radius: 8px;
            transition: all 0.3s ease;
            margin: 0.25rem 1rem;
            font-size: 16px;
        }

        .nav-link:hover, .nav-link.active {
            background: #3182CE;
            color: white;
            transform: translateX(5px);
        }

        .nav-link i {
            margin-right: 0.75rem;
            width: 20px;
            text-align: center;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            margin-left: 280px;
            padding: 1rem;
            min-height: 100vh;
        }

        .header {
            background: #1A202C;
            border: 1px solid #2D3748;
            padding: 1.5rem;
            border-radius: 12px;
            margin-bottom: 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .header h2 {
            color: #ffffff;
            font-size: 1.5rem;
            font-weight: 700;
            margin: 0;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            background: #2563eb;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
        }

        .logout-btn {
            background: #ef4444;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .logout-btn:hover {
            background: #dc2626;
        }

        /* Content Sections */
        .content-section {
            background: #1A202C;
            border: 1px solid #2D3748;
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 2rem;
            display: none;
        }

        .content-section.active {
            display: block;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: linear-gradient(135deg, #2D3748 0%, #4A5568 100%);
            color: white;
            padding: 1.5rem;
            border-radius: 12px;
            text-align: center;
            border: 1px solid #4A5568;
        }

        .stat-card h3 {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .stat-card p {
            opacity: 0.9;
        }

        /* Tables */
        .table-container {
            overflow-x: auto;
            border-radius: 12px;
            border: 1px solid #2D3748;
            background: #1A202C;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: #1A202C;
        }

        th, td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid #2D3748;
            color: #E2E8F0;
        }

        th {
            background: #2D3748;
            font-weight: 600;
            color: #ffffff;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        tr:hover {
            background: #2D3748;
        }

        /* Forms */
        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #E2E8F0;
            font-size: 14px;
        }

        .form-control {
            width: 100%;
            padding: 12px;
            border: 1px solid #4A5568;
            border-radius: 8px;
            font-size: 16px;
            background: #2D3748;
            color: #ffffff;
            transition: border-color 0.3s ease;
        }

        .form-control:focus {
            outline: none;
            border-color: #3182CE;
            box-shadow: 0 0 0 3px rgba(49, 130, 206, 0.1);
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 0.5rem;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: #2563eb;
            color: white;
        }

        .btn-primary:hover {
            background: #1d4ed8;
        }

        .btn-success {
            background: #10b981;
            color: white;
        }

        .btn-success:hover {
            background: #059669;
        }

        .btn-danger {
            background: #ef4444;
            color: white;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 12px;
            margin: 2px;
        }

        /* Login Form */
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: #0B1426;
            padding: 1rem;
        }

        .login-form {
            background: #1A202C;
            border: 1px solid #2D3748;
            padding: 3rem;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
            width: 100%;
            max-width: 400px;
        }

        .login-form h2 {
            text-align: center;
            margin-bottom: 2rem;
            color: #ffffff;
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            .mobile-menu-toggle {
                display: block;
            }

            .sidebar {
                transform: translateX(-100%);
                transition: transform 0.3s ease;
                width: 100%;
                max-width: 320px;
            }

            .sidebar.open {
                transform: translateX(0);
            }

            .main-content {
                margin-left: 0;
                padding: 1rem 0.5rem;
                padding-top: 4rem; /* Space for mobile menu button */
            }

            .header {
                padding: 1rem;
                flex-direction: column;
                text-align: center;
            }

            .header h2 {
                font-size: 1.25rem;
            }

            .stats-grid {
                grid-template-columns: 1fr;
                gap: 1rem;
            }

            .form-grid {
                grid-template-columns: 1fr;
            }

            .table-container {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }

            .table {
                min-width: 600px;
            }

            .btn-sm {
                padding: 8px 12px;
                font-size: 11px;
                margin: 1px;
            }

            .nav-link {
                padding: 1.25rem 1.5rem;
                font-size: 18px;
            }

            .user-info {
                flex-direction: column;
                gap: 0.5rem;
            }
        }

        /* Tablet Responsive */
        @media (max-width: 1024px) and (min-width: 769px) {
            .main-content {
                padding: 1.5rem;
            }

            .form-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Mobile Overlay */
        .mobile-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
        }

        .mobile-overlay.active {
            display: block;
        }

        /* Pull to Refresh */
        .pull-to-refresh {
            position: fixed;
            top: -60px;
            left: 50%;
            transform: translateX(-50%);
            background: #3182CE;
            color: white;
            padding: 10px 20px;
            border-radius: 0 0 20px 20px;
            font-size: 14px;
            font-weight: 600;
            z-index: 1001;
            transition: top 0.3s ease;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }

        .pull-to-refresh.show {
            top: 0;
        }

        .pull-to-refresh.refreshing {
            background: #28a745;
        }

        .refresh-icon {
            display: inline-block;
            margin-right: 8px;
            transition: transform 0.3s ease;
        }

        .refresh-icon.spinning {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="loginScreen" class="login-container">
        <div class="login-form">
            <h2><i class="fas fa-shield-alt"></i> Admin Login</h2>
            <form id="loginForm">
                <div class="form-group">
                    <label for="email">Email</label>
                    <input type="email" id="email" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="password">Password</label>
                    <input type="password" id="password" class="form-control" required>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">
                    <i class="fas fa-sign-in-alt"></i> Login
                </button>
            </form>
        </div>
    </div>

    <!-- Pull to Refresh Indicator -->
    <div class="pull-to-refresh" id="pullToRefresh">
        <i class="fas fa-sync-alt refresh-icon"></i>
        <span id="refreshText">Pull to refresh</span>
    </div>

    <!-- Admin Dashboard -->
    <div id="adminDashboard" class="admin-container" style="display: none;">
        <!-- Mobile Menu Toggle -->
        <button class="mobile-menu-toggle" onclick="toggleMobileMenu()">
            <i class="fas fa-bars"></i>
        </button>

        <!-- Mobile Overlay -->
        <div class="mobile-overlay" onclick="closeMobileMenu()"></div>

        <!-- Sidebar -->
        <nav class="sidebar">
            <div class="logo">
                <h1><i class="fas fa-coins"></i> CoinMarketCap</h1>
                <p>Admin Panel</p>
            </div>
            <ul class="nav-menu">
                <li class="nav-item">
                    <a href="#" class="nav-link active" data-section="dashboard">
                        <i class="fas fa-tachometer-alt"></i> Dashboard
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" data-section="users">
                        <i class="fas fa-users"></i> User Management
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" data-section="balances">
                        <i class="fas fa-wallet"></i> Balance Control
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" data-section="transactions">
                        <i class="fas fa-exchange-alt"></i> Transactions
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" data-section="analytics">
                        <i class="fas fa-chart-bar"></i> Analytics
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" data-section="settings">
                        <i class="fas fa-cog"></i> Settings
                    </a>
                </li>
            </ul>
        </nav>

        <!-- Main Content -->
        <main class="main-content">
            <header class="header">
                <h2 id="pageTitle">Dashboard</h2>
                <div class="user-info">
                    <div class="user-avatar">A</div>
                    <span id="adminEmail">coinmarketsample@gmail.com</span>
                    <button class="logout-btn" onclick="logout()">
                        <i class="fas fa-sign-out-alt"></i> Logout
                    </button>
                </div>
            </header>

            <!-- Dashboard Section -->
            <section id="dashboard" class="content-section active">
                <div class="stats-grid">
                    <div class="stat-card">
                        <h3 id="totalUsers">0</h3>
                        <p>Total Users</p>
                    </div>
                    <div class="stat-card">
                        <h3 id="activeUsers">0</h3>
                        <p>Active Users</p>
                    </div>
                    <div class="stat-card">
                        <h3 id="totalBalance">$0.00</h3>
                        <p>Total Balance</p>
                    </div>
                    <div class="stat-card">
                        <h3 id="todayTransactions">0</h3>
                        <p>Today's Transactions</p>
                    </div>
                </div>
            </section>

            <!-- User Management Section -->
            <section id="users" class="content-section">
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Email</th>
                                <th>Balance</th>
                                <th>Status</th>
                                <th>Registration Date</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="usersTableBody">
                            <!-- Users will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Balance Control Section -->
            <section id="balances" class="content-section">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
                    <div>
                        <h3>Update User Balance</h3>
                        <form id="balanceForm">
                            <div class="form-group">
                                <label for="userSelect">Select User</label>
                                <select id="userSelect" class="form-control" required>
                                    <option value="">Choose a user...</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="balanceAmount">Amount</label>
                                <input type="number" id="balanceAmount" class="form-control" step="0.01" required>
                            </div>
                            <div class="form-group">
                                <label for="balanceAction">Action</label>
                                <select id="balanceAction" class="form-control" required>
                                    <option value="add">Add to Balance</option>
                                    <option value="subtract">Subtract from Balance</option>
                                    <option value="set">Set Balance</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="balanceReason">Reason</label>
                                <input type="text" id="balanceReason" class="form-control" placeholder="Reason for balance change">
                            </div>
                            <button type="submit" class="btn btn-primary">Update Balance</button>
                        </form>
                    </div>
                    <div>
                        <h3>Recent Balance Changes</h3>
                        <div id="recentChanges" style="max-height: 400px; overflow-y: auto;">
                            <!-- Recent changes will be loaded here -->
                        </div>
                    </div>
                </div>
            </section>

            <!-- Transactions Section -->
            <section id="transactions" class="content-section">
                <h3>Transaction History</h3>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>User</th>
                                <th>Type</th>
                                <th>Amount</th>
                                <th>Reason</th>
                            </tr>
                        </thead>
                        <tbody id="transactionsTableBody">
                            <!-- Transactions will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Analytics Section -->
            <section id="analytics" class="content-section">
                <h3>User Analytics</h3>
                <div class="stats-grid">
                    <div class="stat-card">
                        <h3 id="newUsersToday">0</h3>
                        <p>New Users Today</p>
                    </div>
                    <div class="stat-card">
                        <h3 id="avgBalance">$0.00</h3>
                        <p>Average Balance</p>
                    </div>
                    <div class="stat-card">
                        <h3 id="totalTransactions">0</h3>
                        <p>Total Transactions</p>
                    </div>
                    <div class="stat-card">
                        <h3 id="activeToday">0</h3>
                        <p>Active Today</p>
                    </div>
                </div>
            </section>

            <!-- Settings Section -->
            <section id="settings" class="content-section">
                <h3>Admin Settings</h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
                    <div>
                        <h4>Change Admin Password</h4>
                        <form id="passwordForm">
                            <div class="form-group">
                                <label for="currentPassword">Current Password</label>
                                <input type="password" id="currentPassword" class="form-control" required>
                            </div>
                            <div class="form-group">
                                <label for="newPassword">New Password</label>
                                <input type="password" id="newPassword" class="form-control" required>
                            </div>
                            <div class="form-group">
                                <label for="confirmPassword">Confirm New Password</label>
                                <input type="password" id="confirmPassword" class="form-control" required>
                            </div>
                            <button type="submit" class="btn btn-primary">Change Password</button>
                        </form>
                    </div>
                    <div>
                        <h4>System Information</h4>
                        <p><strong>Admin Email:</strong> coinmarketsample@gmail.com</p>
                        <p><strong>Last Login:</strong> <span id="lastLogin">-</span></p>
                        <p><strong>System Status:</strong> <span style="color: green;">Online</span></p>
                        <p><strong>Database:</strong> <span style="color: green;">Connected</span></p>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- Configuration -->
    <script src="config.js"></script>

    <!-- Supabase SDK -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script>
        // Use production configuration
        const CONFIG = window.PRODUCTION_CONFIG;
        console.log('🚀 Admin Panel - Environment:', CONFIG.IS_PRODUCTION ? 'Production' : 'Development');

        // Admin credentials
        const ADMIN_EMAIL = 'coinmarketsample@gmail.com';
        const ADMIN_PASSWORD = 'admin123456';

        // Production-ready Supabase configuration
        let supabaseClient;

        // Initialize Supabase client with production config
        try {
            const { createClient } = supabase;
            supabaseClient = createClient(CONFIG.SUPABASE_URL, CONFIG.SUPABASE_ANON_KEY);
            console.log('✅ Supabase client initialized for admin panel');
            console.log('🔗 Connected to:', CONFIG.SUPABASE_URL);
            console.log('🌐 Environment:', CONFIG.IS_PRODUCTION ? 'Production' : 'Development');
        } catch (error) {
            console.error('❌ Failed to initialize Supabase client:', error);
            console.log('🔧 Using localStorage fallback');
            supabaseClient = null;
        }

        // Navigation
        document.querySelectorAll('.nav-link').forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const section = e.target.closest('.nav-link').dataset.section;
                showSection(section);
            });
        });

        function showSection(sectionName) {
            // Hide all sections
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.remove('active');
            });

            // Remove active class from all nav links
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
            });

            // Show selected section
            document.getElementById(sectionName).classList.add('active');

            // Add active class to clicked nav link
            document.querySelector(`[data-section="${sectionName}"]`).classList.add('active');

            // Update page title
            const titles = {
                dashboard: 'Dashboard',
                users: 'User Management',
                balances: 'Balance Control',
                transactions: 'Transactions',
                analytics: 'Analytics',
                settings: 'Settings'
            };
            document.getElementById('pageTitle').textContent = titles[sectionName];

            // Load section data
            loadSectionData(sectionName);
        }

        // Login functionality with persistent session
        document.getElementById('loginForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;

            if (email === ADMIN_EMAIL && password === ADMIN_PASSWORD) {
                // Save admin session
                const adminSession = {
                    email: email,
                    loginTime: Date.now(),
                    lastActivity: Date.now(),
                    isLoggedIn: true
                };
                localStorage.setItem('adminSession', JSON.stringify(adminSession));

                // Show dashboard
                showAdminDashboard();
            } else {
                alert('Invalid credentials');
            }
        });

        // Show admin dashboard
        function showAdminDashboard() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('adminDashboard').style.display = 'flex';
            loadDashboardData();
            document.getElementById('lastLogin').textContent = new Date().toLocaleString();

            // Update last activity
            updateAdminActivity();
        }

        // Update admin activity timestamp
        function updateAdminActivity() {
            const adminSession = JSON.parse(localStorage.getItem('adminSession') || '{}');
            if (adminSession.isLoggedIn) {
                adminSession.lastActivity = Date.now();
                localStorage.setItem('adminSession', JSON.stringify(adminSession));
            }
        }

        // Check and restore admin session on page load
        function checkAdminSession() {
            const adminSession = JSON.parse(localStorage.getItem('adminSession') || '{}');

            if (adminSession.isLoggedIn) {
                const timeSinceLogin = Date.now() - adminSession.loginTime;
                const timeSinceActivity = Date.now() - adminSession.lastActivity;

                // Session expires after 8 hours or 2 hours of inactivity
                const maxSessionTime = 8 * 60 * 60 * 1000; // 8 hours
                const maxInactivityTime = 2 * 60 * 60 * 1000; // 2 hours

                if (timeSinceLogin < maxSessionTime && timeSinceActivity < maxInactivityTime) {
                    console.log('✅ Admin session restored');
                    showAdminDashboard();
                    return true;
                } else {
                    console.log('⏰ Admin session expired');
                    logout();
                    return false;
                }
            }
            return false;
        }

        // Logout function
        function logout() {
            localStorage.removeItem('adminSession');
            document.getElementById('loginScreen').style.display = 'flex';
            document.getElementById('adminDashboard').style.display = 'none';
            document.getElementById('email').value = '';
            document.getElementById('password').value = '';
        }

        // Logout functionality
        function logout() {
            document.getElementById('loginScreen').style.display = 'flex';
            document.getElementById('adminDashboard').style.display = 'none';
            document.getElementById('loginForm').reset();
        }

        // Load section data
        function loadSectionData(section) {
            switch(section) {
                case 'dashboard':
                    loadDashboardData();
                    break;
                case 'users':
                    loadUsersData();
                    break;
                case 'balances':
                    loadBalanceData();
                    break;
                case 'transactions':
                    loadTransactionsData();
                    break;
                case 'analytics':
                    loadAnalyticsData();
                    break;
            }
        }

        // Load dashboard data from backend
        async function loadDashboardData() {
            try {
                const users = await getAllUsers();
                const totalUsers = users.length;
                const activeUsers = users.filter(user => (user.status || 'active') === 'active').length;
                const totalBalance = users.reduce((sum, user) => sum + (user.balance || 0), 0);
                const todayTransactions = getTodayTransactions().length;

                document.getElementById('totalUsers').textContent = totalUsers;
                document.getElementById('activeUsers').textContent = activeUsers;
                document.getElementById('totalBalance').textContent = `$${totalBalance.toFixed(2)}`;
                document.getElementById('todayTransactions').textContent = todayTransactions;
            } catch (error) {
                console.error('Error loading dashboard data:', error);
            }
        }

        // Load users data from backend
        async function loadUsersData() {
            try {
                const users = await getAllUsers();
                const tbody = document.getElementById('usersTableBody');
                tbody.innerHTML = '';

                if (users.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #A0AEC0;">No users found</td></tr>';
                    return;
                }

                users.forEach(user => {
                    const row = document.createElement('tr');
                    const status = user.status || 'active';
                    const registrationDate = user.registration_date || user.registrationDate || user.created_at || 'N/A';

                    row.innerHTML = `
                        <td>${user.email}</td>
                        <td>$${(user.balance || 0).toFixed(2)}</td>
                        <td><span style="color: ${status === 'active' ? 'green' : 'red'}">${status}</span></td>
                        <td>${typeof registrationDate === 'string' ? registrationDate : new Date(registrationDate).toLocaleDateString()}</td>
                        <td>
                            <button class="btn btn-primary btn-sm" onclick="editUserEmail('${user.email}')">Change Email</button>
                            <button class="btn btn-success btn-sm" onclick="resetUserPassword('${user.email}')">Reset Password</button>
                            <button class="btn btn-danger btn-sm" onclick="blockUser('${user.email}')">
                                ${status === 'blocked' ? 'Unblock' : 'Block'}
                            </button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            } catch (error) {
                console.error('Error loading users data:', error);
                const tbody = document.getElementById('usersTableBody');
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #E53E3E;">Error loading users</td></tr>';
            }
        }

        // Load balance data
        function loadBalanceData() {
            const users = getAllUsers();
            const userSelect = document.getElementById('userSelect');
            userSelect.innerHTML = '<option value="">Choose a user...</option>';

            users.forEach(user => {
                const option = document.createElement('option');
                option.value = user.email;
                option.textContent = `${user.email} ($${(user.balance || 0).toFixed(2)})`;
                userSelect.appendChild(option);
            });

            loadRecentChanges();
        }

        // Balance form submission
        document.getElementById('balanceForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const userEmail = document.getElementById('userSelect').value;
            const amount = parseFloat(document.getElementById('balanceAmount').value);
            const action = document.getElementById('balanceAction').value;
            const reason = document.getElementById('balanceReason').value;

            if (!userEmail || !amount) {
                alert('Please fill in all required fields');
                return;
            }

            updateUserBalance(userEmail, amount, action, reason);
            document.getElementById('balanceForm').reset();
            loadBalanceData();
            loadDashboardData();
        });

        // Update user balance in Supabase backend
        async function updateUserBalance(email, amount, action, reason) {
            try {
                if (supabaseClient) {
                    // First, get current user data from Supabase
                    const { data: users, error: fetchError } = await supabaseClient
                        .from('users')
                        .select('*')
                        .eq('email', email)
                        .single();

                    if (fetchError) {
                        console.error('Error fetching user:', fetchError);
                        updateUserBalanceLocal(email, amount, action, reason);
                        return;
                    }

                    const oldBalance = users.balance || 0;
                    let newBalance = oldBalance;

                    switch(action) {
                        case 'add':
                            newBalance = oldBalance + amount;
                            break;
                        case 'subtract':
                            newBalance = oldBalance - amount;
                            break;
                        case 'set':
                            newBalance = amount;
                            break;
                    }

                    // Update user balance in Supabase
                    const { data: updatedUser, error: updateError } = await supabaseClient
                        .from('users')
                        .update({
                            balance: newBalance,
                            updated_at: new Date().toISOString()
                        })
                        .eq('email', email)
                        .select()
                        .single();

                    if (updateError) {
                        console.error('Error updating user balance:', updateError);
                        updateUserBalanceLocal(email, amount, action, reason);
                        return;
                    }

                    console.log('✅ User balance updated in Supabase');
                } else {
                    // Fallback to localStorage
                    updateUserBalanceLocal(email, amount, action, reason);
                    return;
                }
            } catch (error) {
                console.error('Error in updateUserBalance:', error);
                updateUserBalanceLocal(email, amount, action, reason);
                return;
            }

            // Add transaction record
            const transaction = {
                date: new Date().toLocaleDateString(),
                time: new Date().toLocaleTimeString(),
                user: email,
                type: action,
                amount: amount,
                oldBalance: oldBalance,
                newBalance: newBalance,
                reason: reason || 'Admin update',
                timestamp: Date.now()
            };

            // Save transaction
            const transactions = getTransactions();
            transactions.unshift(transaction);
            localStorage.setItem('admin_transactions', JSON.stringify(transactions));

            // Update user data
            const userId = email.replace('@', '_').replace('.', '_').replace(/[^a-zA-Z0-9_]/g, '_');
            localStorage.setItem(`user_${userId}`, JSON.stringify(user));
            localStorage.setItem(email, JSON.stringify(user));

            // Notify main website
            const updateData = {
                actualAmount: amount,
                realTimeDate: new Date().toLocaleDateString(),
                timestamp: Date.now(),
                oldBalance: oldBalance,
                newBalance: newBalance,
                action: action,
                reason: reason,
                userEmail: email
            };
            localStorage.setItem('balance_update', JSON.stringify(updateData));

            // Cross-domain sync - Send update to main website
            syncToMainWebsite(updateData);

            alert(`Balance updated successfully! New balance: $${newBalance.toFixed(2)}`);
        }

        // Get all users from Supabase backend
        async function getAllUsers() {
            try {
                if (supabaseClient) {
                    // Fetch users from Supabase
                    const { data: users, error } = await supabaseClient
                        .from('users') // Replace 'users' with your actual table name
                        .select('*')
                        .order('created_at', { ascending: false });

                    if (error) {
                        console.error('Error fetching users from Supabase:', error);
                        return getLocalStorageUsers(); // Fallback to localStorage
                    }

                    console.log('✅ Fetched users from Supabase:', users.length);
                    return users || [];
                } else {
                    // Fallback to localStorage if Supabase not available
                    return getLocalStorageUsers();
                }
            } catch (error) {
                console.error('Error in getAllUsers:', error);
                return getLocalStorageUsers(); // Fallback to localStorage
            }
        }

        // Fallback function to get users from localStorage
        function getLocalStorageUsers() {
            const users = [];
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.startsWith('user_') && !key.includes('@')) {
                    try {
                        const userData = JSON.parse(localStorage.getItem(key));
                        if (userData && userData.email) {
                            users.push(userData);
                        }
                    } catch (e) {
                        // Skip invalid data
                    }
                }
            }
            console.log('📦 Using localStorage fallback, found users:', users.length);
            return users;
        }

        // Get transactions
        function getTransactions() {
            try {
                return JSON.parse(localStorage.getItem('admin_transactions')) || [];
            } catch (e) {
                return [];
            }
        }

        // Get today's transactions
        function getTodayTransactions() {
            const today = new Date().toLocaleDateString();
            return getTransactions().filter(transaction => transaction.date === today);
        }

        // Load transactions data
        function loadTransactionsData() {
            const transactions = getTransactions();
            const tbody = document.getElementById('transactionsTableBody');
            tbody.innerHTML = '';

            transactions.slice(0, 50).forEach(transaction => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${transaction.date} ${transaction.time}</td>
                    <td>${transaction.user}</td>
                    <td>${transaction.type}</td>
                    <td style="color: ${transaction.type === 'add' ? 'green' : 'red'}">
                        ${transaction.type === 'add' ? '+' : transaction.type === 'subtract' ? '-' : ''}$${transaction.amount.toFixed(2)}
                    </td>
                    <td>${transaction.reason}</td>
                `;
                tbody.appendChild(row);
            });
        }

        // Load analytics data
        function loadAnalyticsData() {
            const users = getAllUsers();
            const transactions = getTransactions();
            const today = new Date().toLocaleDateString();

            const newUsersToday = users.filter(user => user.registrationDate === today).length;
            const avgBalance = users.length > 0 ? users.reduce((sum, user) => sum + (user.balance || 0), 0) / users.length : 0;
            const totalTransactions = transactions.length;
            const activeToday = users.filter(user => user.lastLogin === today).length;

            document.getElementById('newUsersToday').textContent = newUsersToday;
            document.getElementById('avgBalance').textContent = `$${avgBalance.toFixed(2)}`;
            document.getElementById('totalTransactions').textContent = totalTransactions;
            document.getElementById('activeToday').textContent = activeToday;
        }

        // Load recent changes
        function loadRecentChanges() {
            const transactions = getTransactions().slice(0, 10);
            const container = document.getElementById('recentChanges');
            container.innerHTML = '';

            transactions.forEach(transaction => {
                const div = document.createElement('div');
                div.style.cssText = 'padding: 1rem; border: 1px solid #e5e7eb; border-radius: 0.5rem; margin-bottom: 0.5rem;';
                div.innerHTML = `
                    <strong>${transaction.user}</strong><br>
                    <span style="color: ${transaction.type === 'add' ? 'green' : 'red'}">
                        ${transaction.type === 'add' ? '+' : transaction.type === 'subtract' ? '-' : ''}$${transaction.amount.toFixed(2)}
                    </span><br>
                    <small>${transaction.date} ${transaction.time}</small><br>
                    <small>${transaction.reason}</small>
                `;
                container.appendChild(div);
            });
        }

        // Change user email function with Supabase backend
        async function editUserEmail(currentEmail) {
            const newEmail = prompt('Enter new email for user:', currentEmail);

            if (!newEmail || newEmail === currentEmail) {
                return;
            }

            // Validate email format
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(newEmail)) {
                alert('Please enter a valid email address');
                return;
            }

            try {
                if (supabaseClient) {
                    // Check if new email already exists in Supabase
                    const { data: existingUser, error: checkError } = await supabaseClient
                        .from('users')
                        .select('email')
                        .eq('email', newEmail)
                        .single();

                    if (existingUser) {
                        alert('This email is already in use by another user');
                        return;
                    }

                    // Update user email in Supabase
                    const { data: updatedUser, error: updateError } = await supabaseClient
                        .from('users')
                        .update({
                            email: newEmail,
                            updated_at: new Date().toISOString()
                        })
                        .eq('email', currentEmail)
                        .select()
                        .single();

                    if (updateError) {
                        console.error('Error updating user email:', updateError);
                        alert('Failed to update email. Please try again.');
                        return;
                    }

                    console.log('✅ User email updated in Supabase');
                } else {
                    // Fallback to localStorage
                    editUserEmailLocal(currentEmail, newEmail);
                    return;
                }

                // Sync with main website
                const updateData = {
                    type: 'EMAIL_CHANGE',
                    oldEmail: currentEmail,
                    newEmail: newEmail,
                    timestamp: Date.now(),
                    userEmail: newEmail
                };
                syncToMainWebsite(updateData);

                alert(`✅ User email changed successfully from ${currentEmail} to ${newEmail}`);
                loadUsersData();
                loadDashboardData();

            } catch (error) {
                console.error('Error in editUserEmail:', error);
                alert('Failed to update email. Please try again.');
            }
        }

        // Fallback function for localStorage email updates
        function editUserEmailLocal(currentEmail, newEmail) {
            const users = getLocalStorageUsers();
            const emailExists = users.some(user => user.email === newEmail);
            if (emailExists) {
                alert('This email is already in use by another user');
                return;
            }

            const userIndex = users.findIndex(user => user.email === currentEmail);
            if (userIndex !== -1) {
                const user = users[userIndex];
                user.email = newEmail;

                // Update localStorage with new email
                const userId = currentEmail.replace('@', '_').replace('.', '_').replace(/[^a-zA-Z0-9_]/g, '_');
                const newUserId = newEmail.replace('@', '_').replace('.', '_').replace(/[^a-zA-Z0-9_]/g, '_');

                // Remove old entries
                localStorage.removeItem(`user_${userId}`);
                localStorage.removeItem(currentEmail);

                // Add new entries
                localStorage.setItem(`user_${newUserId}`, JSON.stringify(user));
                localStorage.setItem(newEmail, JSON.stringify(user));

                // Sync with main website
                const updateData = {
                    type: 'EMAIL_CHANGE',
                    oldEmail: currentEmail,
                    newEmail: newEmail,
                    timestamp: Date.now(),
                    userEmail: newEmail
                };
                syncToMainWebsite(updateData);

                alert(`User email changed successfully from ${currentEmail} to ${newEmail}`);
                loadUsersData();
                loadDashboardData();
            }
        }

        // Reset user password function with Supabase backend
        async function resetUserPassword(email) {
            const newPassword = prompt('Enter new password for user (minimum 6 characters):');

            if (!newPassword) {
                return;
            }

            if (newPassword.length < 6) {
                alert('Password must be at least 6 characters long');
                return;
            }

            try {
                if (supabaseClient) {
                    // Update user password in Supabase
                    const { data: updatedUser, error: updateError } = await supabaseClient
                        .from('users')
                        .update({
                            password: newPassword, // In production, this should be hashed
                            password_changed_by: 'admin',
                            password_changed_at: new Date().toISOString(),
                            updated_at: new Date().toISOString()
                        })
                        .eq('email', email)
                        .select()
                        .single();

                    if (updateError) {
                        console.error('Error updating user password:', updateError);
                        alert('Failed to reset password. Please try again.');
                        return;
                    }

                    console.log('✅ User password updated in Supabase');
                } else {
                    // Fallback to localStorage
                    resetUserPasswordLocal(email, newPassword);
                    return;
                }

                // Sync with main website
                const updateData = {
                    type: 'PASSWORD_RESET',
                    userEmail: email,
                    newPassword: newPassword,
                    timestamp: Date.now()
                };
                syncToMainWebsite(updateData);

                alert(`✅ Password reset successfully for ${email}. New password: ${newPassword}`);
                loadUsersData();

            } catch (error) {
                console.error('Error in resetUserPassword:', error);
                alert('Failed to reset password. Please try again.');
            }
        }

        // Fallback function for localStorage password reset
        function resetUserPasswordLocal(email, newPassword) {
            const users = getLocalStorageUsers();
            const userIndex = users.findIndex(user => user.email === email);

            if (userIndex !== -1) {
                const user = users[userIndex];
                user.password = newPassword;
                user.passwordChangedBy = 'admin';
                user.passwordChangedAt = new Date().toISOString();

                // Update localStorage
                const userId = email.replace('@', '_').replace('.', '_').replace(/[^a-zA-Z0-9_]/g, '_');
                localStorage.setItem(`user_${userId}`, JSON.stringify(user));
                localStorage.setItem(email, JSON.stringify(user));

                // Sync with main website
                const updateData = {
                    type: 'PASSWORD_RESET',
                    userEmail: email,
                    newPassword: newPassword,
                    timestamp: Date.now()
                };
                syncToMainWebsite(updateData);

                alert(`Password reset successfully for ${email}. New password: ${newPassword}`);
                loadUsersData();
            }
        }

        // Block/Unblock user function with Supabase backend
        async function blockUser(email) {
            try {
                if (supabaseClient) {
                    // First get current user status
                    const { data: user, error: fetchError } = await supabaseClient
                        .from('users')
                        .select('status')
                        .eq('email', email)
                        .single();

                    if (fetchError) {
                        console.error('Error fetching user status:', fetchError);
                        blockUserLocal(email);
                        return;
                    }

                    const newStatus = user.status === 'blocked' ? 'active' : 'blocked';

                    // Update user status in Supabase
                    const { data: updatedUser, error: updateError } = await supabaseClient
                        .from('users')
                        .update({
                            status: newStatus,
                            updated_at: new Date().toISOString()
                        })
                        .eq('email', email)
                        .select()
                        .single();

                    if (updateError) {
                        console.error('Error updating user status:', updateError);
                        alert('Failed to update user status. Please try again.');
                        return;
                    }

                    console.log('✅ User status updated in Supabase');
                    alert(`✅ User ${newStatus === 'blocked' ? 'blocked' : 'unblocked'} successfully`);
                } else {
                    // Fallback to localStorage
                    blockUserLocal(email);
                    return;
                }

                loadUsersData();
                loadDashboardData();

            } catch (error) {
                console.error('Error in blockUser:', error);
                alert('Failed to update user status. Please try again.');
            }
        }

        // Fallback function for localStorage user blocking
        function blockUserLocal(email) {
            const users = getLocalStorageUsers();
            const userIndex = users.findIndex(user => user.email === email);

            if (userIndex !== -1) {
                const user = users[userIndex];
                user.status = user.status === 'blocked' ? 'active' : 'blocked';

                const userId = email.replace('@', '_').replace('.', '_').replace(/[^a-zA-Z0-9_]/g, '_');
                localStorage.setItem(`user_${userId}`, JSON.stringify(user));
                localStorage.setItem(email, JSON.stringify(user));

                alert(`User ${user.status === 'blocked' ? 'blocked' : 'unblocked'} successfully`);
                loadUsersData();
                loadDashboardData();
            }
        }

        // Password change form
        document.getElementById('passwordForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;

            if (currentPassword !== ADMIN_PASSWORD) {
                alert('Current password is incorrect');
                return;
            }

            if (newPassword !== confirmPassword) {
                alert('New passwords do not match');
                return;
            }

            if (newPassword.length < 6) {
                alert('New password must be at least 6 characters long');
                return;
            }

            // In a real application, you would update the password in the database
            alert('Password changed successfully! Please update the ADMIN_PASSWORD constant in the code.');
            document.getElementById('passwordForm').reset();
        });

        // Cross-domain sync functions
        function syncToMainWebsite(updateData) {
            // Method 1: Use BroadcastChannel API (works across tabs on same origin)
            try {
                const channel = new BroadcastChannel('coinmarketcap_sync');
                channel.postMessage({
                    type: 'BALANCE_UPDATE',
                    data: updateData
                });
            } catch (e) {
                console.log('BroadcastChannel not supported');
            }

            // Method 2: Use localStorage events (works across tabs on same origin)
            localStorage.setItem('sync_trigger', JSON.stringify({
                timestamp: Date.now(),
                type: updateData.type || 'BALANCE_UPDATE',
                data: updateData
            }));

            // Method 3: Cross-domain iframe communication
            try {
                // Create hidden iframe to main website
                const iframe = document.createElement('iframe');
                iframe.style.display = 'none';
                iframe.src = 'https://coinbasenew.vercel.app/';
                document.body.appendChild(iframe);

                iframe.onload = function() {
                    // Send message to main website
                    iframe.contentWindow.postMessage({
                        type: 'ADMIN_UPDATE',
                        data: updateData
                    }, 'https://coinbasenew.vercel.app');

                    // Remove iframe after 5 seconds
                    setTimeout(() => {
                        if (iframe.parentNode) {
                            iframe.parentNode.removeChild(iframe);
                        }
                    }, 5000);
                };
            } catch (e) {
                console.log('Cross-domain iframe blocked:', e);
            }

            // Method 4: Use a shared external service (fallback)
            try {
                // Store in a way that can be accessed by main website
                const syncData = {
                    ...updateData,
                    syncId: 'coinmarketcap_' + Date.now(),
                    adminTimestamp: Date.now()
                };

                // Use a unique key that main website can check
                localStorage.setItem('admin_sync_' + updateData.userEmail.replace(/[^a-zA-Z0-9]/g, '_'), JSON.stringify(syncData));
            } catch (e) {
                console.log('Sync fallback failed:', e);
            }
        }

        // Listen for sync responses from main website
        window.addEventListener('message', function(event) {
            // Only accept messages from your main website
            if (event.origin !== 'https://coinbasenew.vercel.app') {
                return;
            }

            if (event.data.type === 'SYNC_CONFIRMED') {
                console.log('✅ Main website confirmed sync:', event.data);
                // Show success notification in admin
                alert('✅ Balance update synced to main website successfully!');
            }
        });

        // Mobile menu functions
        function toggleMobileMenu() {
            const sidebar = document.querySelector('.sidebar');
            const overlay = document.querySelector('.mobile-overlay');

            sidebar.classList.toggle('open');
            overlay.classList.toggle('active');
        }

        function closeMobileMenu() {
            const sidebar = document.querySelector('.sidebar');
            const overlay = document.querySelector('.mobile-overlay');

            sidebar.classList.remove('open');
            overlay.classList.remove('active');
        }

        // Close mobile menu when clicking nav links
        document.querySelectorAll('.nav-link').forEach(link => {
            link.addEventListener('click', () => {
                if (window.innerWidth <= 768) {
                    closeMobileMenu();
                }
            });
        });

        // Handle window resize
        window.addEventListener('resize', () => {
            if (window.innerWidth > 768) {
                closeMobileMenu();
            }
        });

        // Pull to Refresh functionality
        let startY = 0;
        let currentY = 0;
        let pullDistance = 0;
        let isPulling = false;
        let isRefreshing = false;

        function initPullToRefresh() {
            const pullToRefresh = document.getElementById('pullToRefresh');
            const refreshIcon = pullToRefresh.querySelector('.refresh-icon');
            const refreshText = document.getElementById('refreshText');

            // Touch events for mobile
            document.addEventListener('touchstart', (e) => {
                if (window.scrollY === 0 && !isRefreshing) {
                    startY = e.touches[0].clientY;
                    isPulling = true;
                }
            }, { passive: true });

            document.addEventListener('touchmove', (e) => {
                if (isPulling && !isRefreshing) {
                    currentY = e.touches[0].clientY;
                    pullDistance = Math.max(0, currentY - startY);

                    if (pullDistance > 0) {
                        e.preventDefault();
                        const progress = Math.min(pullDistance / 100, 1);

                        if (pullDistance > 60) {
                            pullToRefresh.classList.add('show');
                            refreshText.textContent = 'Release to refresh';
                            refreshIcon.style.transform = `rotate(${pullDistance * 2}deg)`;
                        } else {
                            refreshText.textContent = 'Pull to refresh';
                        }
                    }
                }
            }, { passive: false });

            document.addEventListener('touchend', () => {
                if (isPulling && pullDistance > 60 && !isRefreshing) {
                    triggerRefresh();
                } else {
                    resetPullToRefresh();
                }
                isPulling = false;
                pullDistance = 0;
            });

            // Mouse events for desktop testing
            document.addEventListener('mousedown', (e) => {
                if (window.scrollY === 0 && !isRefreshing && e.clientY < 100) {
                    startY = e.clientY;
                    isPulling = true;
                }
            });

            document.addEventListener('mousemove', (e) => {
                if (isPulling && !isRefreshing) {
                    currentY = e.clientY;
                    pullDistance = Math.max(0, currentY - startY);

                    if (pullDistance > 60) {
                        pullToRefresh.classList.add('show');
                        refreshText.textContent = 'Release to refresh';
                    }
                }
            });

            document.addEventListener('mouseup', () => {
                if (isPulling && pullDistance > 60 && !isRefreshing) {
                    triggerRefresh();
                } else {
                    resetPullToRefresh();
                }
                isPulling = false;
                pullDistance = 0;
            });
        }

        function triggerRefresh() {
            if (isRefreshing) return;

            isRefreshing = true;
            const pullToRefresh = document.getElementById('pullToRefresh');
            const refreshIcon = pullToRefresh.querySelector('.refresh-icon');
            const refreshText = document.getElementById('refreshText');

            pullToRefresh.classList.add('show', 'refreshing');
            refreshIcon.classList.add('spinning');
            refreshText.textContent = 'Refreshing...';

            // Refresh all data
            Promise.all([
                loadDashboardData(),
                loadUsersData(),
                loadBalanceData(),
                loadAnalyticsData()
            ]).then(() => {
                setTimeout(() => {
                    resetPullToRefresh();
                    showNotification('✅ Data refreshed successfully!', 'success');
                }, 1000);
            }).catch(() => {
                setTimeout(() => {
                    resetPullToRefresh();
                    showNotification('❌ Refresh failed. Please try again.', 'error');
                }, 1000);
            });
        }

        function resetPullToRefresh() {
            const pullToRefresh = document.getElementById('pullToRefresh');
            const refreshIcon = pullToRefresh.querySelector('.refresh-icon');
            const refreshText = document.getElementById('refreshText');

            pullToRefresh.classList.remove('show', 'refreshing');
            refreshIcon.classList.remove('spinning');
            refreshIcon.style.transform = 'rotate(0deg)';
            refreshText.textContent = 'Pull to refresh';
            isRefreshing = false;
        }

        // Simple notification function
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${type === 'success' ? '#28a745' : type === 'error' ? '#dc3545' : '#3182CE'};
                color: white;
                padding: 12px 20px;
                border-radius: 8px;
                font-size: 14px;
                font-weight: 600;
                z-index: 1002;
                box-shadow: 0 4px 12px rgba(0,0,0,0.2);
                transform: translateX(100%);
                transition: transform 0.3s ease;
            `;
            notification.textContent = message;
            document.body.appendChild(notification);

            setTimeout(() => notification.style.transform = 'translateX(0)', 100);
            setTimeout(() => {
                notification.style.transform = 'translateX(100%)';
                setTimeout(() => document.body.removeChild(notification), 300);
            }, 3000);
        }

        // Initialize dashboard on page load
        document.addEventListener('DOMContentLoaded', () => {
            // Check for existing admin session
            if (!checkAdminSession()) {
                // No valid session, show login screen
                document.getElementById('loginScreen').style.display = 'flex';
                document.getElementById('adminDashboard').style.display = 'none';
            }

            // Initialize mobile menu event listeners
            const navLinks = document.querySelectorAll('.nav-link');
            navLinks.forEach(link => {
                link.addEventListener('click', () => {
                    if (window.innerWidth <= 768) {
                        closeMobileMenu();
                    }
                    updateAdminActivity(); // Track activity
                });
            });

            // Track user activity for session management
            ['click', 'keypress', 'scroll', 'mousemove'].forEach(event => {
                document.addEventListener(event, updateAdminActivity, { passive: true });
            });

            // Initialize pull-to-refresh
            initPullToRefresh();
        });
    </script>
</body>
</html>
